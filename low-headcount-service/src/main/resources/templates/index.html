<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>SAP SUCCESSFACTORS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://chmsbxproaz.eu12.sapdas.cloud.sap/resources/public/webclient/bootstrap.js"
        data-bot-name="sadgiassis"
        data-expander-type="DEFAULT"
        data-expander-preferences="JTdCJTIyb25ib2FyZGluZ01lc3NhZ2UlMjIlM0ElMjJDb21lJTIwc3BlYWslMjB0byUyMG1lJTIxJTIyJTJDJTIyZXhwYW5kZXJUaXRsZSUyMiUzQSUyMiUyMiUyQyUyMmV4cGFuZGVyTG9nbyUyMiUzQSUyMkNVWF9BdmF0YXIuc3ZnJTIyJTJDJTIydGhlbWUlMjIlM0ElMjJzYXBfaG9yaXpvbiUyMiU3RA==">
    </script>

    <style>
        body {
            background-color: #f0f5fc;
            font-family: 'Segoe UI', sans-serif;
            color: #333;
        }

        /* Header Bar */
        .header-bar {
            background-color: white;
            padding: 0.5rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            min-height: 75px;
        }

        .header-bar h1 {
            font-weight: 600;
            font-size: 1.3rem;
            margin: 0;
            color: #0a6ed1;
        }

        .icon-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sap-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            cursor: pointer;
            object-fit: cover;
            border: 1px solid #eee;
            vertical-align: middle;
        }

        /* Notification Button */
        .notification-btn {
            width: 48px;
            height: 48px;
            /* font-size: 28px; */ /* <-- REMOVED this line */
            background: none;
            border: none;
            position: relative;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* Optional: Style the icon itself if needed */
        .notification-btn i {
             font-size: 1.5rem; /* Example size: Adjust as needed */
             line-height: 1;
        }


        .notification-btn:hover {
            color: #0a6ed1;
        }

        .notification-btn .badge {
            font-size: 15px;
            min-width: 30px;
            height: 25px;
            padding: 4px 4px 4px;
            line-height: 16px;
            top: -3px;
            right: -8px;
            animation: blinking 1.5s infinite;
            border: 1px solid white;
            position: absolute;
        }

        @keyframes blinking {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Quick Actions */
        .quick-actions-section h2 {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-action-tile {
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            text-align: center;
            padding: 0.8rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            font-size: 0.85rem;
        }

        .quick-action-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            filter: brightness(110%);
        }

        .quick-action-tile i {
            font-size: 1.6rem;
            margin-bottom: 0.2rem;
        }

        /* Tile Color Variants */
        .tile-blue-dark { background-color: #0b5ed7; }
        .tile-pink-dark { background-color: #c72374; }
        .tile-teal-dark { background-color: #1a9f78; }
        .tile-gray-dark { background-color: #5c636a; }
        .tile-purple-dark { background-color: #59359a; }

        /* Dropdown */
        .dropdown-menu {
            max-height: 350px;
            overflow-y: auto;
            width: 350px;
            padding-top: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border: none;
        }

        .dropdown-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
        }

        .dropdown-item-custom {
            padding: 0.5rem 1rem;
            margin: 2px 0;
            border-radius: 0.25rem;
        }

        .show-more-link {
            font-size: 12px;
            text-align: right;
            cursor: pointer;
            color: #007bff;
            padding: 0.25rem 1rem 0.5rem 1rem;
            display: block;
        }

        /* Ask Joule Buttons */
        .ask-joule-btn-sm {
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            line-height: 1.2;
            margin-left: auto;
        }

        .modal-ask-joule-btn {
            position: absolute;
            top: 0.8rem;
            right: 3.5rem;
            z-index: 1056;
        }

        /* Modal */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-content {
            border-radius: 0.5rem;
            border: none;
        }

        .modal-header, .modal-footer {
            border-color: #dee2e6;
        }

        /* Criticality Styles */
        .criticality-high {
            background-color: #f8d7da !important;
            border-color: #f5c2c7 !important;
            color: #842029 !important;
            border-left: 4px solid #dc3545 !important;
        }

        .criticality-medium {
            background-color: #fff3cd !important;
            border-color: #ffecb5 !important;
            color: #664d03 !important;
            border-left: 4px solid #ffc107 !important;
        }

        .criticality-low {
            background-color: #d1e7dd !important;
            border-color: #badbcc !important;
            color: #0f5132 !important;
            border-left: 4px solid #198754 !important;
        }

        .criticality-header {
            font-weight: bold;
            padding: 10px;
            margin: 15px 0 8px 0;
            border-radius: 5px;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .criticality-header i {
            font-size: 1.2em;
        }

        .criticality-header-high { background-color: #dc3545; }
        .criticality-header-medium { background-color: #ffc107; color: #212529; }
        .criticality-header-low { background-color: #198754; }

        /* Notification Item */
        .notification-item {
            cursor: pointer;
            margin-bottom: 5px;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            padding: 0.6rem 0.8rem !important;
        }

        .notification-item:hover {
            transform: translateX(5px);
        }

        .notification-item i {
            margin-right: 0.7rem;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .notification-item span {
            flex-grow: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Data Section */
        .data-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 2rem;
            border: 1px solid #e9ecef;
        }

        /* Tabs */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-link {
            border: none;
            border-bottom: 2px solid transparent;
            color: #6c757d;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            margin-bottom: -2px;
            font-size: 0.9rem;
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: transparent;
            border-bottom: 2px solid #0d6efd;
            font-weight: 600;
        }

        .nav-tabs .nav-link:hover {
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd;
        }

        .tab-content {
            min-height: 150px;
        }

        /* Tables */
        .table {
            margin-bottom: 0;
            font-size: 0.88rem;
        }

        .table thead th {
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            border-top: none;
            white-space: nowrap;
            padding: 0.6rem 0.75rem;
        }

        .table tbody td {
            vertical-align: middle;
            color: #333;
            padding: 0.6rem 0.75rem;
            border-color: #f1f3f5;
        }

        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Table Specific Status/Rating Styles (assumed from context, add if needed) */
        .status-badge, .rating-badge, .rec-badge {
             padding: 0.2em 0.6em;
             border-radius: 0.25rem;
             font-size: 0.75em;
             font-weight: 600;
             display: inline-block;
             line-height: 1;
             text-align: center;
             white-space: nowrap;
             vertical-align: baseline;
        }
        .status-open { background-color: #cfe2ff; color: #084298; }
        .status-pending { background-color: #fff3cd; color: #664d03; }
        .status-filled { background-color: #d1e7dd; color: #0f5132; }
        .rating-good { background-color: #d1e7dd; color: #0f5132; }
        .rating-average { background-color: #fff3cd; color: #664d03; }
        .rating-poor { background-color: #f8d7da; color: #842029; }
        .rec-hire { background-color: #d1e7dd; color: #0f5132; }
        .rec-hold { background-color: #fff3cd; color: #664d03; }
        .rec-no-hire { background-color: #f8d7da; color: #842029; }
        .trend-up { color: #198754; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }

    </style>
</head>
<body>

<div class="header-bar">
    <h1>SAP SUCCESSFACTORS</h1>
    <div class="icon-area">

        <div class="dropdown">
            <button class="btn btn-light position-relative notification-btn" type="button" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-bell-fill"></i> <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      th:text="${#lists.size(headcountNotifications) + #lists.size(learningNotifications)}">0</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">

                <li>
                    <div class="dropdown-header-custom">
                        <h6 class="dropdown-header px-0 py-0">Notifications</h6>
                        <button class="btn btn-outline-primary btn-sm ask-joule-btn-sm" onclick="openJoule(0)">Ask Joule</button>
                    </div>
                </li>
                 <li><hr class="dropdown-divider mt-1 mb-1"></li>

                <li th:if="${not #lists.isEmpty(headcountNotifications)}">
                    <div class="dropdown-header-custom">
                        <strong class="text-primary">Headcount Data</strong>
                    </div>
                    <div class="alert dropdown-item-custom p-2 m-1 criticality-high notification-item" onclick="openJoule(1)">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>URGENT:</strong> Headcount Dipped
                    </div>

                    <div th:if="${#lists.size(headcountNotifications) > 1}"
                         class="show-more-link"
                         onclick="showNotificationModal('headcount')">
                        Show more...
                    </div>
                     <li><hr class="dropdown-divider mt-1 mb-1"></li>
                </li>

                <li th:if="${not #lists.isEmpty(learningNotifications)}">
                    <div class="dropdown-header-custom">
                        <strong class="text-success">Learning Hours Data</strong>
                    </div>
                     <div class="alert dropdown-item-custom p-2 m-1 criticality-high notification-item" onclick="openJoule(2)">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>URGENT:</strong> Learning Hours Dipped
                    </div>

                    <div th:if="${#lists.size(learningNotifications) > 1}"
                         class="show-more-link"
                         onclick="showNotificationModal('learning')">
                         Show more...
                    </div>
                    <li><hr class="dropdown-divider mt-1 mb-1"></li>
                </li>

                <li th:if="${#lists.isEmpty(headcountNotifications) and #lists.isEmpty(learningNotifications)}" class="text-muted text-center p-3">
                    No new notifications
                </li>
            </ul>
        </div>

        <a href="https://chmsbxproaz.eu12.sapdas.cloud.sap/webclient/standalone/sadgiassis" target="_blank">
            <img class="sap-icon"
                 src="https://www.sap.com/dam/site/sapcom/multimedia/2023/09/b6a38432-8e7e-0010-bca6-c68f7e60039b.mp4/_jcr_content/renditions/cq5dam.thumbnail.640.360.jpg"
                 alt="SAP Joule"
                 title="Explore SAP Joule">
        </a>
    </div>
</div>

<div class="container mt-4">
    <div class="quick-actions-section mb-4">
         <h2>QUICK ACTIONS</h2>
         <div class="row g-3">
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-blue-dark"><i class="bi bi-book"></i><span>View My Learning</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-pink-dark"><i class="bi bi-people"></i><span>Manage My Team</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-teal-dark"><i class="bi bi-clock-history"></i><span>Clock My Time</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-gray-dark"><i class="bi bi-calendar-plus"></i><span>Request Time Off</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-purple-dark"><i class="bi bi-diagram-3"></i><span>View Org Chart</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-blue-dark"><i class="bi bi-bullseye"></i><span>Manage My Goals</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-pink-dark"><i class="bi bi-graph-up-arrow"></i><span>Growth Portfolio</span></div></div>
            <div class="col-6 col-md-3"><div class="quick-action-tile tile-teal-dark"><i class="bi bi-person-gear"></i><span>Dynamic Teams</span></div></div>
         </div>
    </div>

    <div class="data-section">
        <ul class="nav nav-tabs" id="dataTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="requisitions-tab" data-bs-toggle="tab" data-bs-target="#requisitions-pane" type="button" role="tab" aria-controls="requisitions-pane" aria-selected="true">Job Requisitions</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback-pane" type="button" role="tab" aria-controls="feedback-pane" aria-selected="false">Interview Feedback</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics-pane" type="button" role="tab" aria-controls="metrics-pane" aria-selected="false">People Metrics</button>
          </li>
        </ul>

        <div class="tab-content" id="dataTabsContent">
          <div class="tab-pane fade show active" id="requisitions-pane" role="tabpanel" aria-labelledby="requisitions-tab" tabindex="0">
             <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead><tr><th scope="col">Req ID</th><th scope="col">Position</th><th scope="col">Department</th><th scope="col">Status</th><th scope="col">Open Since</th><th scope="col">Candidates</th></tr></thead>
                    <tbody>
                      <tr><td>REQ-2025-105</td><td>Senior Software Engineer</td><td>Engineering</td><td><span class="status-badge status-open">Open</span></td><td>15 days</td><td>8</td></tr>
                      <tr><td>REQ-2025-104</td><td>HR Business Partner</td><td>Human Resources</td><td><span class="status-badge status-pending">Pending Approval</span></td><td>5 days</td><td>0</td></tr>
                      <tr><td>REQ-2025-103</td><td>Product Manager</td><td>Product</td><td><span class="status-badge status-filled">Filled</span></td><td>32 days</td><td>12</td></tr>
                       <tr><td>REQ-2025-102</td><td>UX Designer</td><td>Design</td><td><span class="status-badge status-open">Open</span></td><td>22 days</td><td>15</td></tr>
                    </tbody>
                </table>
             </div>
          </div>

          <div class="tab-pane fade" id="feedback-pane" role="tabpanel" aria-labelledby="feedback-tab" tabindex="0">
             <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th scope="col">Candidate</th>
                        <th scope="col">Position</th>
                        <th scope="col">Interviewer</th>
                        <th scope="col">Date</th>
                        <th scope="col">Overall Rating</th>
                        <th scope="col">Recommendation</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Alice Wonderland</td>
                        <td>Senior Software Engineer</td>
                        <td>Bob The Builder</td>
                        <td>2025-05-01</td>
                        <td><span class="rating-badge rating-good">Good</span></td>
                        <td><span class="rec-badge rec-hire">Hire</span></td>
                      </tr>
                       <tr>
                        <td>Charlie Chaplin</td>
                        <td>UX Designer</td>
                        <td>Diana Prince</td>
                        <td>2025-04-28</td>
                        <td><span class="rating-badge rating-average">Average</span></td>
                        <td><span class="rec-badge rec-hold">Hold</span></td>
                      </tr>
                       <tr>
                        <td>Edward Scissorhands</td>
                        <td>Senior Software Engineer</td>
                        <td>Bob The Builder</td>
                        <td>2025-05-02</td>
                         <td><span class="rating-badge rating-poor">Poor</span></td>
                        <td><span class="rec-badge rec-no-hire">No Hire</span></td>
                      </tr>
                       <tr>
                        <td>Fiona Shrek</td>
                        <td>HR Business Partner</td>
                        <td>Grace Hopper</td>
                        <td>2025-04-30</td>
                         <td><span class="rating-badge rating-good">Good</span></td>
                        <td><span class="rec-badge rec-hire">Hire</span></td>
                      </tr>
                    </tbody>
                </table>
             </div>
          </div>

          <div class="tab-pane fade" id="metrics-pane" role="tabpanel" aria-labelledby="metrics-tab" tabindex="0">
             <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th scope="col">Metric</th>
                        <th scope="col">Value</th>
                        <th scope="col">Trend (vs Last Quarter)</th>
                        <th scope="col">Target</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Active Headcount</td>
                        <td>1,450</td>
                        <td><i class="bi bi-arrow-up trend-up"></i> +25</td>
                        <td>1,500</td>
                      </tr>
                      <tr>
                        <td>Avg. Employee Tenure</td>
                        <td>4.2 Years</td>
                         <td><i class="bi bi-arrow-down trend-down"></i> -0.1yr</td>
                        <td>4.5 Years</td>
                      </tr>
                      <tr>
                        <td>Quarterly Attrition Rate</td>
                        <td>3.5%</td>
                        <td><i class="bi bi-arrow-up trend-down"></i> +0.5%</td>
                        <td>&lt; 3.0%</td>
                      </tr>
                       <tr>
                        <td>Avg. Training Hours / Employee</td>
                        <td>18.5 hrs</td>
                        <td><i class="bi bi-arrow-right trend-stable"></i> +0 hrs</td>
                        <td>20 hrs</td>
                      </tr>
                       <tr>
                        <td>Diversity Ratio (Female/Male)</td>
                        <td>42% / 58%</td>
                        <td><i class="bi bi-arrow-up trend-up"></i> +1% Female</td>
                        <td>45% / 55%</td>
                      </tr>
                    </tbody>
                </table>
             </div>
          </div>

        </div>
    </div>

</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">All Notifications</h5>
        <button type="button" id="modalAskJouleBtn" class="btn btn-outline-primary modal-ask-joule-btn" onclick="openJoule(0)">Ask Joule</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalNotificationContent">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script th:inline="javascript">
    /*<![CDATA[*/
    // Sample data - replace with actual data in production
    const allHeadcountNotifications = /*[[${headcountNotifications}]]*/ [
        "Headcount in Engineering reduced by 5%",
        "IT Department shows 8% decline in personnel",
        "Marketing team headcount increased by 2%",
        "Sales team staffing below target by 12%",
        "Production team shows critical staffing gap of 15%",
        "Finance department showing 3% understaffing",
        "R&D team requires immediate hiring, 18% understaffed",
        "Customer support team headcount stable",
        "Administrative staff over budget by 4%"
    ];

    const allLearningNotifications = /*[[${learningNotifications}]]*/ [
        "Compliance training completion rate dropped to 78%",
        "Technical skills training hours increased by 5%",
        "Management training hours below target by 15%",
        "New hire onboarding showing 20% delay",
        "Safety training needs immediate attention, 25% below requirement",
        "Sales training completion rate at acceptable 92%",
        "Product knowledge training hours up by 8%",
        "Leadership development program underutilized by 10%"
    ];

    let notificationModal = null; // To hold the modal instance

    document.addEventListener('DOMContentLoaded', (event) => {
        // Initialize the modal instance once the DOM is ready
        const modalElement = document.getElementById('notificationModal');
        if (modalElement) {
            notificationModal = new bootstrap.Modal(modalElement);
        }

        // Sort notifications when the DOM is loaded
        sortNotifications();
    });

    /*]]>*/
</script>

<script>
    // Function to sort notifications in ascending order (based on numeric value if present)
    function sortNotifications() {
        const sortFn = (a, b) => {
            const aMatch = a.match(/[-+]?\d+(\.\d+)?%?/); // Match numbers potentially followed by %
            const bMatch = b.match(/[-+]?\d+(\.\d+)?%?/);
            let aVal = null;
            let bVal = null;

            if (aMatch) aVal = parseFloat(aMatch[0]);
            if (bMatch) bVal = parseFloat(bMatch[0]);

            // Prioritize negative changes or larger percentage drops/gaps (more critical)
            // Treat decreases/gaps as 'more negative' = higher priority
            // Treat increases as 'less negative' or positive = lower priority
            // If one is negative and the other positive, negative comes first.
            if (aVal !== null && bVal !== null) {
                 // Simple numeric sort might put large positive numbers first.
                 // Let's adjust logic based on keywords if needed, or rely on simple value sort for now
                 // Example: If 'below target', 'decline', 'reduced', 'gap', 'understaffed' treat as more critical.
                 // For simplicity, we'll just sort numerically ascending for now.
                 // Consider more complex logic if strict criticality ordering is needed beyond value.
                 return aVal - bVal; // Ascending sort by number
            } else if (aVal !== null) {
                return -1; // Numbers come before non-numbers
            } else if (bVal !== null) {
                return 1; // Non-numbers come after numbers
            }
            return a.localeCompare(b); // Fallback to string comparison
        };


        if (allHeadcountNotifications && allHeadcountNotifications.length > 0) {
            allHeadcountNotifications.sort(sortFn);
        }

        if (allLearningNotifications && allLearningNotifications.length > 0) {
            allLearningNotifications.sort(sortFn);
        }
    }


    // Function to determine criticality class based on index in the sorted array
    function getCriticalityClass(index, totalItems) {
        if (!totalItems || totalItems === 0) return 'criticality-low';

        const highThreshold = Math.ceil(totalItems * 0.33);
        const mediumThreshold = Math.ceil(totalItems * 0.66);

        // Assuming lower index after sort means higher criticality
        if (index < highThreshold) {
            return 'criticality-high'; // Top 33% - Red
        } else if (index < mediumThreshold) {
            return 'criticality-medium'; // Middle 33% - Yellow
        } else {
            return 'criticality-low'; // Bottom 33% - Green
        }
    }

    // Modify openJoule function to close dropdown/modal
    function openJoule(widgetId) {
        if (window.sap.das.webclient) {
            // --- Begin: Close Dropdown and Modal Logic ---
            try {
                // Close the notification dropdown if it's open
                const dropdownTriggerEl = document.getElementById('notificationDropdown');
                if (dropdownTriggerEl) {
                    const dropdownInstance = bootstrap.Dropdown.getInstance(dropdownTriggerEl);
                    // Ensure instance exists and check if shown before hiding
                    if (dropdownInstance && (dropdownTriggerEl.classList.contains('show') || dropdownTriggerEl.getAttribute('aria-expanded') === 'true')) {
                         dropdownInstance.hide();
                    }
                }

                // Close the notification modal if it's open and the instance exists
                if (notificationModal) { // notificationModal is the global instance
                     const modalElement = document.getElementById('notificationModal');
                     // Ensure modal element exists and check if shown before hiding
                     if (modalElement && modalElement.classList.contains('show')) {
                        notificationModal.hide();
                     }
                }
            } catch (error) {
                console.error("Error hiding dropdown or modal:", error);
            }
            // --- End: Close Dropdown and Modal Logic ---


            // --- Joule Interaction Logic (existing) ---
            window.sap.das.webclient.resetConversation();
            let prompt = '';
            if (widgetId === 1) {
                prompt = "Show me headcount data widget.";
            } else if (widgetId === 2) {
                prompt = "Show me learning hours data widget.";
            }
            else {
                 prompt = "Can you show me all the available widgets?"; // Default prompt
            }
            // Only send message if a prompt is set
            if (prompt) {
               window.sap.das.webclient.sendMessage(prompt);
            }
            // Always toggle Joule when the button is clicked
            window.sap.das.webclient.toggle();
            // --- End: Joule Interaction Logic ---

        } else {
            console.error('Joule Web Client not loaded.');
            alert('Joule Web Client is not available.'); // User feedback
        }
    }

    function showNotificationModal(type) {
        if (!notificationModal) {
            console.error('Notification modal instance not ready.');
            return;
        }

        const modalTitle = document.getElementById('notificationModalLabel');
        const modalBody = document.getElementById('modalNotificationContent');
        const modalJouleBtn = document.getElementById('modalAskJouleBtn');
        let notificationsToShow = [];
        let jouleWidgetId = 0;

        modalBody.innerHTML = ''; // Clear previous content

        if (type === 'headcount') {
            modalTitle.textContent = 'All Headcount Notifications';
            notificationsToShow = allHeadcountNotifications;
            jouleWidgetId = 1;
        } else if (type === 'learning') {
            modalTitle.textContent = 'All Learning Hours Notifications';
            notificationsToShow = allLearningNotifications;
            jouleWidgetId = 2;
        } else {
            console.error('Unknown notification type:', type);
            return;
        }

        modalJouleBtn.setAttribute('onclick', `openJoule(${jouleWidgetId})`);

        if (notificationsToShow.length > 0) {
            const groupedNotifications = { high: [], medium: [], low: [] };

            notificationsToShow.forEach((note, index) => {
                const criticalityClass = getCriticalityClass(index, notificationsToShow.length);
                const item = { note, index, jouleWidgetId };
                if (criticalityClass === 'criticality-high') {
                    groupedNotifications.high.push(item);
                } else if (criticalityClass === 'criticality-medium') {
                    groupedNotifications.medium.push(item);
                } else {
                    groupedNotifications.low.push(item);
                }
            });

            const createSection = (title, iconClass, headerClass, items) => {
                if (items.length === 0) return;

                const header = document.createElement('div');
                header.className = `criticality-header ${headerClass}`;
                header.innerHTML = `<i class="bi ${iconClass}"></i> ${title}`;
                modalBody.appendChild(header);

                items.forEach(item => {
                    const div = document.createElement('div');
                    // Determine the specific alert class based on the grouping
                    let alertClass = '';
                    if (headerClass.includes('high')) alertClass = 'criticality-high';
                    else if (headerClass.includes('medium')) alertClass = 'criticality-medium';
                    else alertClass = 'criticality-low';

                    div.className = `alert p-2 m-1 ${alertClass} notification-item`;
                    // Make urgent/important items bold
                    div.innerHTML = (alertClass === 'criticality-high' || alertClass === 'criticality-medium')
                                     ? `<strong>${item.note}</strong>`
                                     : item.note;
                    div.style.cursor = 'pointer';
                    div.onclick = () => openJoule(item.jouleWidgetId);
                    modalBody.appendChild(div);
                });
            };

            createSection('URGENT - Immediate Action Required', 'bi-exclamation-triangle-fill', 'criticality-header-high', groupedNotifications.high);
            createSection('IMPORTANT - Action Required Soon', 'bi-exclamation-circle-fill', 'criticality-header-medium', groupedNotifications.medium);
            createSection('NORMAL - For Information', 'bi-info-circle-fill', 'criticality-header-low', groupedNotifications.low);

        } else {
            modalBody.innerHTML = '<p class="text-muted">No notifications for this category.</p>';
        }

        notificationModal.show();
    }
</script>

</body>
</html>